services:
  webapp:
    build: 
      context: ./app
      args:
        - DJANGO_ENV=prod
    env_file: .env
    # Override settings for the webapp module
    environment:
      - DJANGO_SETTINGS_MODULE=hive_sbi_webapp.settings.prod
    # Run the webapp's specific gunicorn server
    command: >
      sh -c "python manage.py migrate && 
             python manage.py collectstatic --noinput && 
             su -m app -c 'gunicorn hive_sbi_webapp.wsgi -b :8008'"
    volumes:
      # Persist the SQLite database file
      - webapp_data:/app/db.sqlite3
      - ./app/static:/app/static
    ports:
      - "127.0.0.1:5008:8008" 
    restart: unless-stopped

  api:
    build: 
      context: ./app
      args:
        - DJANGO_ENV=prod
    env_file: .env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "127.0.0.1:5009:8009"
    restart: unless-stopped

  redis:
    image: redis:alpine
    restart: unless-stopped

  celery_worker:
    build: 
      context: ./app
      args:
        - DJANGO_ENV=prod
    # Overriding the script to add safety limits
    command: su -m app -c "celery -A hive_sbi_api worker -l info --concurrency=1 --max-tasks-per-child=10"
    depends_on:
      - redis
      - webapp
    env_file: .env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    # Physical hardware limit
    deploy:
      resources:
        limits:
          memory: 2G

  celery_beat:
    build: 
      context: ./app
      args:
        - DJANGO_ENV=prod
    command: sh /app/boot_scripts/beat.sh
    env_file: .env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - redis
      - webapp
    volumes:
      - webapp_data:/app/db.sqlite3
      - beat_data:/app/beat_data
    restart: unless-stopped

volumes:
  webapp_data:
  beat_data:
